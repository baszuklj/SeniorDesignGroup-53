<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>URL Guardian — Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="border-b bg-white">
    <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">URL Guardian</h1>
      <nav class="flex gap-2">
        <button id="navAnalyze" class="px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">Analyze</button>
        <button id="navHistory" class="px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">History</button>
        <button id="navAdmin"   class="px-3 py-2 rounded-lg hover:bg-slate-100 font-medium">Admin</button>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <!-- API base config -->
    <div class="mb-6">
      <label class="block text-sm font-medium mb-1" for="apiBase">API Base URL</label>
      <div class="flex gap-2">
        <input id="apiBase" type="url" class="w-full rounded-lg border px-3 py-2"
               value="http://127.0.0.1:8000" />
        <button id="apiSave" class="px-4 py-2 rounded-lg bg-black text-white">Use</button>
      </div>
      <p class="text-xs text-slate-500 mt-1">If your backend runs elsewhere, change this (e.g., http://localhost:8080).</p>
    </div>

    <!-- Analyze Panel -->
    <section id="panelAnalyze" class="space-y-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">Analyze a URL</h2>
        <form id="analyzeForm" class="flex flex-col sm:flex-row gap-3">
          <input id="urlInput" type="url" required placeholder="https://example.com"
                 class="flex-1 rounded-lg border px-3 py-2" />
          <button class="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Analyze</button>
        </form>
        <div id="analyzeMsg" class="mt-3 text-sm"></div>
      </div>

      <div id="resultCard" class="hidden bg-white rounded-2xl shadow p-5">
        <div class="flex items-center justify-between">
          <div>
            <h3 id="resUrl" class="text-lg font-semibold break-all"></h3>
            <p class="text-sm text-slate-500">Domain: <span id="resDomain"></span></p>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold" id="resScore">0</div>
            <div id="resVerdict" class="text-sm font-medium"></div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="rounded-xl border p-4">
            <h4 class="font-semibold mb-2">Status</h4>
            <dl class="grid grid-cols-2 gap-x-3 text-sm">
              <dt>Blocked</dt><dd id="resBlocked">false</dd>
              <dt>Google Safe Browsing</dt><dd id="resGSB">-</dd>
              <dt>VirusTotal</dt><dd id="resVT">-</dd>
              <dt>SSL Labs</dt><dd id="resSSL">-</dd>
              <dt>PhishTank</dt><dd id="resPT">-</dd>
            </dl>
          </div>
          <div class="rounded-xl border p-4">
            <h4 class="font-semibold mb-2">Actions</h4>
            <button id="btnBlockDomain" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">
              Block this domain
            </button>
          </div>
        </div>

        <details class="mt-4">
          <summary class="cursor-pointer font-medium">Raw details</summary>
          <pre id="resRaw" class="mt-2 text-xs bg-slate-900 text-slate-100 rounded-lg p-3 overflow-auto"></pre>
        </details>
      </div>
    </section>

    <!-- History Panel -->
    <section id="panelHistory" class="hidden">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Recent Analyses</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm">Limit</label>
            <select id="histLimit" class="rounded-lg border px-2 py-1">
              <option>10</option><option>25</option><option selected>50</option><option>100</option>
            </select>
            <button id="refreshHistory" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 pr-2">Time</th>
                <th class="py-2 pr-2">URL</th>
                <th class="py-2 pr-2">Domain</th>
                <th class="py-2 pr-2">Verdict</th>
                <th class="py-2 pr-2">Score</th>
                <th class="py-2 pr-2">Blocked</th>
              </tr>
            </thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="panelAdmin" class="hidden">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">Block a Domain</h2>
        <form id="blockForm" class="flex flex-col sm:flex-row gap-3">
          <input id="blockDomain" type="text" placeholder="bad.example"
                 class="flex-1 rounded-lg border px-3 py-2" required />
          <input id="blockReason" type="text" placeholder="reason (optional)"
                 class="flex-1 rounded-lg border px-3 py-2" />
          <button class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Block</button>
        </form>
        <div id="blockMsg" class="mt-3 text-sm"></div>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-5xl px-4 py-8 text-xs text-slate-500">
    <p>© <span id="year"></span> URL Guardian. Local demo UI.</p>
  </footer>

  <script>
    // --- Basic view switching
    const panelAnalyze = document.getElementById('panelAnalyze');
    const panelHistory = document.getElementById('panelHistory');
    const panelAdmin   = document.getElementById('panelAdmin');
    const showPanel = (p) => {
      [panelAnalyze, panelHistory, panelAdmin].forEach(el => el.classList.add('hidden'));
      p.classList.remove('hidden');
    };
    document.getElementById('navAnalyze').onclick = () => showPanel(panelAnalyze);
    document.getElementById('navHistory').onclick = () => { showPanel(panelHistory); loadHistory(); };
    document.getElementById('navAdmin').onclick   = () => showPanel(panelAdmin);
    document.getElementById('year').textContent = new Date().getFullYear();

    // --- API base handling
    const apiBaseInput = document.getElementById('apiBase');
    const apiSaveBtn = document.getElementById('apiSave');
    const getBase = () => (localStorage.getItem('apiBase') || apiBaseInput.value).replace(/\/+$/, '');
    const setBase = (v) => { localStorage.setItem('apiBase', v); apiBaseInput.value = v; };
    apiSaveBtn.onclick = () => setBase(apiBaseInput.value);
    // load stored base
    (function() { const stored = localStorage.getItem('apiBase'); if (stored) apiBaseInput.value = stored; })();

    // --- Analyze form
    const analyzeForm = document.getElementById('analyzeForm');
    const urlInput = document.getElementById('urlInput');
    const analyzeMsg = document.getElementById('analyzeMsg');
    const resultCard = document.getElementById('resultCard');
    const resUrl = document.getElementById('resUrl');
    const resDomain = document.getElementById('resDomain');
    const resScore = document.getElementById('resScore');
    const resVerdict = document.getElementById('resVerdict');
    const resBlocked = document.getElementById('resBlocked');
    const resGSB = document.getElementById('resGSB');
    const resVT  = document.getElementById('resVT');
    const resSSL = document.getElementById('resSSL');
    const resPT  = document.getElementById('resPT');
    const resRaw = document.getElementById('resRaw');
    const btnBlockDomain = document.getElementById('btnBlockDomain');

    analyzeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      analyzeMsg.textContent = '';
      resultCard.classList.add('hidden');

      const url = urlInput.value.trim();
      if (!url) return;

      try {
        const r = await fetch(getBase() + '/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (!r.ok) throw new Error('Analyze failed: ' + r.status);
        const data = await r.json();

        // Populate card
        resUrl.textContent = data.url;
        resDomain.textContent = data.domain;
        resScore.textContent = data.risk_score.toFixed(2);
        resVerdict.textContent = data.verdict;
        resVerdict.className = 'text-sm font-medium ' + (
          data.verdict === 'unsafe' ? 'text-red-600' :
          data.verdict === 'suspicious' ? 'text-amber-600' : 'text-emerald-600'
        );
        resBlocked.textContent = data.blocked ? 'true' : 'false';

        const svc = data.services || {};
        resGSB.textContent = svc.google_safe_browsing ? `${svc.google_safe_browsing.status} (${svc.google_safe_browsing.score})` : '-';
        resVT.textContent  = svc.virustotal ? `${svc.virustotal.status} (${svc.virustotal.score})` : '-';
        resSSL.textContent = svc.ssllabs ? `${svc.ssllabs.status} (${svc.ssllabs.score})` : '-';
        resPT.textContent  = svc.phishtank ? `${svc.phishtank.status} (${svc.phishtank.score})` : '-';

        resRaw.textContent = JSON.stringify(data, null, 2);
        resultCard.classList.remove('hidden');

        // Block button wires to the analyzed domain
        btnBlockDomain.onclick = async () => {
          try {
            const br = await fetch(getBase() + '/api/admin/block', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ domain: data.domain, reason: 'from UI' })
            });
            if (!br.ok) throw new Error('Block failed: ' + br.status);
            const blk = await br.json();
            resBlocked.textContent = blk.blocked ? 'true' : 'false';
            alert(`Domain "${blk.domain}" blocked (${blk.reason}).`);
          } catch (err) {
            alert('Failed to block: ' + err.message);
          }
        };
      } catch (err) {
        analyzeMsg.className = 'mt-3 text-sm text-red-600';
        analyzeMsg.textContent = err.message;
      }
    });

    // --- History
    const histBody = document.getElementById('histBody');
    const histLimit = document.getElementById('histLimit');
    const refreshBtn = document.getElementById('refreshHistory');

    async function loadHistory() {
      histBody.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="6">Loading…</td></tr>`;
      try {
        const r = await fetch(getBase() + `/api/history?limit=${encodeURIComponent(histLimit.value)}`);
        if (!r.ok) throw new Error('History failed: ' + r.status);
        const rows = await r.json();
        if (!rows.length) {
          histBody.innerHTML = `<tr><td class="py-3 text-slate-500" colspan="6">No history yet.</td></tr>`;
          return;
        }
        histBody.innerHTML = rows.map(item => {
          const verdictColor =
            item.verdict === 'unsafe' ? 'text-red-600' :
            item.verdict === 'suspicious' ? 'text-amber-600' : 'text-emerald-600';
          return `
            <tr class="border-b last:border-0">
              <td class="py-2 pr-2 whitespace-nowrap">${new Date(item.submitted_at).toLocaleString()}</td>
              <td class="py-2 pr-2 break-all"><a class="text-blue-700 hover:underline" href="${item.url}" target="_blank" rel="noopener">${item.url}</a></td>
              <td class="py-2 pr-2 whitespace-nowrap">${item.domain}</td>
              <td class="py-2 pr-2 whitespace-nowrap ${verdictColor} font-medium">${item.verdict}</td>
              <td class="py-2 pr-2 whitespace-nowrap">${item.risk_score.toFixed(2)}</td>
              <td class="py-2 pr-2 whitespace-nowrap">${item.blocked ? 'true' : 'false'}</td>
            </tr>`;
        }).join('');
      } catch (err) {
        histBody.innerHTML = `<tr><td class="py-3 text-red-600" colspan="6">${err.message}</td></tr>`;
      }
    }
    refreshBtn.onclick = loadHistory;
    histLimit.onchange = loadHistory;

    // default route visible
    showPanel(panelAnalyze);
  </script>
</body>
</html>
